---
title: "Estimating the gender wage gap in France"
author: "Yacine, Victoria and Raphaële"
date: "11/23/2021"
output: 
 github_document : 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE, message=FALSE, include=TRUE,
                      cache=FALSE)

#setwd("/Users/hugomarty/Documents/GitHub/Project-of-Econometrics/EE_2018")
library(haven)
#d <- read_dta("~/Documents/GitHub/Project-of-Econometrics/EE_2018/Bases/EEC_2018INDIV.dta")

library(questionr)
library(tidyverse)
library(hrbrthemes)
library(foreign)
library(dplyr)
library(stargazer)

# Réduire la base de données -----

#Garder seulement les temps complets et les salaires réalistes ----

#sum(d$tppred == 1)
#d <- subset(d,tppred==1 & salmee >=988 & salmee<=9999997, drop=TRUE) 
#save(d, file = "EE_2018_allege.RData")
load("EE_2018_allege.RData")

#Garder seulement les variables d'intérêt -----

dr <- d %>% select(ident,
                  salmee, #salaire continu
                  sexe, #sexe
                  ag, #âge en variable continue
                  nbenfa18, #nombre d'nefants de moins 18
                  dip5, # éducation en 13 postes
                  cser, #CPS
                  nafg004n, # primaire / secondaire / tertiaire
                  chpub, # public / privé
                  ancentr) # ancienneté 
  

#immi, # être immigré
#desc,#être descendant
#zus# zone urbaine sensible 

#Changer le format des variables -----

dr <- dr  %>% mutate_at(vars(salmee, ag, nbenfa18, ancentr), funs(as.numeric)) %>% mutate_at(vars(sexe, dip5, cser, chpub), funs(as.factor))

# education, employment, household charecteristics, gender, occupation, industry, age)


```


# First Table: Table with brief summary statistics.

```{r,results='asis'}

## Summary statistics -----
# Sample size -----
n<-nrow(d) #nombre d'observations
n
# Average age in the population -----

d$ag <- as.numeric(d$ag)
mean<-mean(d$ag)
mean

# Distribution of education ------

d$dip5 <- as.numeric(d$dip5)

#tab_ed <- table(d$dip5)
#view(tab_ed)
#sort(tab_ed)
#barplot(sort(tab_ed), col = "skyblue", main = "Répartition de la population selon le niveau de diplôme atteint")

freq_ed <- freq(d$dip5) 
freq_ed

# Occupation ------

d$cser <- as.numeric(d$cser)
#hist(d$cser, main = "Répartition de la population selon la profession occupée")

freq_occupation <- freq(d$cser) 
freq_occupation

#Table with all the summary statistics --------

# A FAIRE


```


# Second Table: Regressions, Gendar gap - controlling for various variables
Perform a regression of log wages on a gender dummy variable without other controls (unconditional wage gap). Perform similar regressions but include progressively additional sets of control variables. Report regression results in a single table across different columns as in an academic paper. Comment the results

\tiny

```{r, results='asis'}

## Régression triviale -------
dr$logsal <- log(dr$salmee)
reg0 <- lm(dr$logsal ~ dr$sexe)


## Sélection des variables de contrôle -------
# Ajout de variables de contrôle
#Choix des variables


## Reg 1 en ajoutant l'éducation -------
reg1 <- lm(logsal ~ sexe + dip5, data = dr) # salaires, sexe, éducation

## Reg 2 en ajoutant l'ancienneté-------

reg2 <-lm(logsal ~ sexe + dip5 + ancentr, data = dr) # salaires, sexe, éducation, ancienneté, 

## Reg 3 en ajoutant le secteur ou public/privé-------

dr$sector <- dr$nafg004n
#sum(dr$sector == "00") #1907
dr$sector[dr$sector == "00"] <- NA
#sum(is.na(dr$sector))

levels(dr$sector) <- c(levels(dr$sector), "S", "I","A")
dr$sector[dr$sector == "EV"] <- "S"
dr$sector[dr$sector == "ET"] <- "I"
dr$sector[dr$sector == "EU"] <- "I"
dr$sector[dr$sector == "ES"] <- "A"

dr$sector <- as.factor(dr$sector)

reg3 <- lm(logsal ~ sexe + dip5 + ancentr + sector, data = dr) # salaires, sexe, éducation, ancienneté, secteur
reg3bis <- lm(logsal ~ sexe + dip5 + ancentr + chpub, data = dr) # salaires, sexe, éducation, ancienneté, public vs privé

## Regression 4 en ajoutant le nombre d'enfants -------

reg4 <- lm(logsal ~ sexe + dip5 + ancentr + sector + nbenfa18, data = dr) # salaires, sexe, éducation, ancienneté, secteur, nombre d'enfants de moins 18

## Tableau sunthétique des régressions ------
library(reshape2)
table2 <- stargazer(reg0, reg1, reg2, reg3, reg3bis, reg4, 
          type = "latex",
          header=F, 
          title = "Comparaison des régressions",
          column.sep.width = "0,1pt",
          font.size = "tiny")

#   covariate.labels = c("Sexe", "Niveau de diplôme", "Ancienneté","Secteur", "Public ou privé", "Nombre d'enfants de moins de 18ans")

```

## Comments on the regressions

\normalsize

# 5) Third Table: More vs Less than high-school education
Perform the same exercise but separately for those with more and less than high-school education

```{r, results='asis'}

dr$highschool <- ifelse(d$dip5<3,1,0) # égal à 1 quand l'individu a  fait  d'études supérieurs

reg2_onlyhs <- lm(formula = logsal[highschool=='0'] ~ sexe[highschool=='0'], data = d)
reg2_abovehs <- lm(formula = logsal[highschool=='1'] ~ sexe[highschool=='1'], data = d)

Table3 <- stargazer(reg2_onlyhs, reg2_abovehs)

```


# Fourth Table (not compulsory): Further analysis 
Perform further analysis that you might find interesting 

Inclure les temps partiels ! 

# Tests
## Multicolinéarité

Le calcul des facteurs d'inflation de la variance, égaux à `r vif(reg4)` , nous indique l'absence de multicolinéarité dans notre modèle.

Pour l'améliorer, nous identifions ensuite les points atypiques en procédant au calcul des *hat values*. Un point est dit atypique si sa *hat value* est 3 fois supérieure à la moyenne.

```{r}
library(car)
# D’abord, calculer les "hatvalues".
reg4_hat <- hatvalues(reg4)
# Sortir un graphique avec les hatvalues.
plot(reg4_hat)
# Ajouter des lignes pour la moyenne et pour trois fois la moyenne.
abline(h=c(1,3)*mean(reg4_hat),col=2)

# Identifier les observations aberrantes sur le graphique.
id <- which(reg4_hat>3*mean(reg4_hat))

```


## Test des hypothèses GM
### H1-H3
Des trois premières hypothèses de Gauss-Markov, nous ne vérifions que la première qui est évidente au vu de notre première régression.

### H4 : Hétéroscédasticité
```{r}
ggplot(mapping = aes(x = dr$logsal, y = reg4$residuals)) +
  geom_point() + geom_smooth()
```
### H5 : absence de corrélations des résidus
```{r}
#Test de Durbin-Watson
library(lmtest)
dwtest(reg4)  # hypothèse nulle valide : il y a non auto-corrélation entre les résidus
```


### H6 : Normalité des résidus

```{r}
#QQ plot
e4 <- reg4$residuals 
qqnorm(e7,datax=TRUE,ylab="Quantiles observés",xlab="Quantiles théoriques")
```

# Comment